<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Şifre Sıfırlama</title>
  </head>
  <body style="font-family: Arial; display:flex; flex-direction:column; align-items:center; padding:40px;">
    <h2>Yeni Şifre Belirle</h2>

    <p id="handoff" style="margin:10px 0; display:none;">
      Uygulama açılıyor… Açılmazsa aşağıdan web üzerinden devam edebilirsiniz.
    </p>

    <input id="password" type="password" placeholder="Yeni şifre" style="margin:8px; padding:8px; width:250px;"/>
    <input id="confirm" type="password" placeholder="Yeni şifre (tekrar)" style="margin:8px; padding:8px; width:250px;"/>
    <button id="submit" style="padding:10px 20px; cursor:pointer; margin-top:10px;">Şifreyi Güncelle</button>
    <p id="result" style="margin-top:20px;"></p>

    <button id="openApp" style="padding:8px 14px; margin-top:16px; display:none;">Uygulamada aç</button>

    <script type="module">
      import { Client, Account } from "https://esm.sh/appwrite";

      // ---- Appwrite client (web fallback) ----
      const client = new Client()
        .setEndpoint("https://fra.cloud.appwrite.io/v1")
        .setProject("686b1f5f0031e12b789a");
      const account = new Account(client);

      const params = new URLSearchParams(window.location.search);
      const userId = params.get("userId");
      const secret = params.get("secret");

      // ---- 1) Uygulamayı açmayı dene (deep link) ----
      const deepLink = `expoapp://reset-password?userId=${encodeURIComponent(userId || "")}&secret=${encodeURIComponent(secret || "")}`;
      const openAppBtn = document.getElementById("openApp");
      const handoff = document.getElementById("handoff");

      if (userId && secret) {
        // Bazı tarayıcılar engelleyebilir; yine de dene:
        setTimeout(() => {
          // Görsel geri dönüş için küçük bir bilgi mesajı:
          handoff.style.display = "block";
          // Deep link denemesi:
          window.location.href = deepLink;
          // 1-2 sn sonra “Uygulamada aç” butonunu göster (manuel)
          setTimeout(() => { openAppBtn.style.display = "inline-block"; }, 1200);
        }, 100);
      }

      openAppBtn.addEventListener("click", () => {
        window.location.href = deepLink;
      });

      // ---- 2) Web üzerinden reset fallback ----
      document.getElementById("submit").addEventListener("click", async () => {
        const pass = document.getElementById("password").value;
        const confirm = document.getElementById("confirm").value;
        const result = document.getElementById("result");

        if (!userId || !secret) {
          result.textContent = "❌ Bağlantı parametreleri eksik (userId/secret). Maildeki linke tekrar tıklayın.";
          return;
        }
        if (pass.length < 8) {
          result.textContent = "Şifre en az 8 karakter olmalı.";
          return;
        }
        if (pass !== confirm) {
          result.textContent = "Şifreler uyuşmuyor.";
          return;
        }

        try {
          await account.updateRecovery(userId, secret, pass, confirm);
          result.textContent = "✅ Şifre güncellendi. Uygulamaya giriş yapabilirsiniz.";
        } catch (err) {
          result.textContent = "❌ Hata: " + err.message;
        }
      });
    </script>
  </body>
</html>