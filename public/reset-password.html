<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Åifre SÄ±fÄ±rlama | QuizHero</title>
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
   <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <div class="container">
      <div class="quiz-icon">ğŸ¯</div>
      <h2>QuizHero Åifre SÄ±fÄ±rlama</h2>
      <p id="handoff" class="hint" style="display:none;">
        Uygulama aÃ§Ä±lamazsa aÅŸaÄŸÄ±dan web Ã¼zerinden devam edin ğŸ®
      </p>

      <div class="field">
        <label for="password">Yeni ÅŸifre</label>
        <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" inputmode="text" autocomplete="new-password" />
      </div>
      <div class="field">
        <label for="confirm">Yeni ÅŸifre (tekrar)</label>
        <input id="confirm" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" inputmode="text" autocomplete="new-password" />
      </div>

      <button id="submit" class="btn">ğŸ”’ Åifreyi GÃ¼ncelle</button>
      <button id="openApp" class="btn">ğŸ“± Uygulamada AÃ§</button>

      <div class="footer">Â© 2025 QuizHero â€¢ Bilgi gÃ¼cÃ¼nÃ¼ gÃ¶ster!</div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    
    <script type="module">
      import { Client, Account } from "https://esm.sh/appwrite";

      const client = new Client()
        .setEndpoint("https://fra.cloud.appwrite.io/v1")
        .setProject("686b1f5f0031e12b789a");
      const account = new Account(client);

      const params = new URLSearchParams(window.location.search);
      const userId = params.get("userId");
      const secret = params.get("secret");

      const deepLink = `expoapp://reset-password?userId=${encodeURIComponent(userId || "")}&secret=${encodeURIComponent(secret || "")}`;
      const openAppBtn = document.getElementById("openApp");
      const handoff = document.getElementById("handoff");

      if (userId && secret) {
        handoff.style.display = "block";
        openAppBtn.style.display = "block";
      }

      openAppBtn.addEventListener("click", () => {
        try {
          window.location.href = deepLink;
        } catch {
          Swal.fire({
            icon: 'warning',
            title: 'UyarÄ±!',
            text: 'Uygulama aÃ§Ä±lamadÄ±, web Ã¼zerinden devam edin.',
            confirmButtonText: 'Tamam',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#ff9800'
          });
        }
      });

      // Web Ã¼zerinden reset
      document.getElementById("submit").addEventListener("click", async () => {
        const pass = document.getElementById("password").value.trim();
        const confirm = document.getElementById("confirm").value.trim();

        if (!userId || !secret) {
          Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'BaÄŸlantÄ± parametreleri eksik. Maildeki linke tekrar tÄ±klayÄ±n.',
            confirmButtonText: 'Tamam',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#f44336'
          });
          return;
        }

        if (pass.length < 8) {
          Swal.fire({
            icon: 'warning',
            title: 'Åifre KÄ±sa!',
            text: 'Åifre en az 8 karakter olmalÄ±.',
            confirmButtonText: 'Tamam',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#ff9800'
          });
          return;
        }

        if (pass !== confirm) {
          Swal.fire({
            icon: 'error',
            title: 'UyuÅŸmazlÄ±k!',
            text: 'Åifreler birbiriyle uyuÅŸmuyor.',
            confirmButtonText: 'Tekrar Dene',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#f44336'
          });
          return;
        }

        try {
          await account.updateRecovery(userId, secret, pass, confirm);
          
          Swal.fire({
            icon: 'success',
            title: 'BaÅŸarÄ±lÄ±!',
            html: 'âœ… <strong>Åifre baÅŸarÄ±yla gÃ¼ncellendi!</strong><br>ArtÄ±k giriÅŸ yapabilirsiniz ğŸ‰',
            confirmButtonText: 'Harika!',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#4CAF50',
            timer: 5000,
            timerProgressBar: true
          }).then(() => {
            // Ä°steÄŸe baÄŸlÄ±: BaÅŸarÄ±lÄ± olunca giriÅŸ sayfasÄ±na yÃ¶nlendir
            // window.location.href = '/login';
          });
          
        } catch (err) {
          Swal.fire({
            icon: 'error',
            title: 'Ä°ÅŸlem BaÅŸarÄ±sÄ±z!',
            text: 'Hata: ' + (err?.message || 'Bilinmeyen hata oluÅŸtu'),
            confirmButtonText: 'Tekrar Dene',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#f44336'
          });
        }
      });
    </script>
  </body>
</html>