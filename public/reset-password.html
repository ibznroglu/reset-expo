<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Şifre Sıfırlama | QuizHero</title>
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
   <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <div class="container">
      <div class="quiz-icon">🎯</div>
      <h2>QuizHero Şifre Sıfırlama</h2>
      <p id="handoff" class="hint" style="display:none;">
        Uygulama açılamazsa aşağıdan web üzerinden devam edin 🎮
      </p>

      <div class="field">
        <label for="password">Yeni şifre</label>
        <input id="password" type="password" placeholder="••••••••" inputmode="text" autocomplete="new-password" />
      </div>
      <div class="field">
        <label for="confirm">Yeni şifre (tekrar)</label>
        <input id="confirm" type="password" placeholder="••••••••" inputmode="text" autocomplete="new-password" />
      </div>

      <button id="submit" class="btn">🔒 Şifreyi Güncelle</button>
      <button id="openApp" class="btn">📱 Uygulamada Aç</button>

      <div class="footer">© 2025 QuizHero • Bilgi gücünü göster!</div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    
    <script type="module">
      import { Client, Account } from "https://esm.sh/appwrite";

      const client = new Client()
        .setEndpoint("https://fra.cloud.appwrite.io/v1")
        .setProject("686b1f5f0031e12b789a");
      const account = new Account(client);

      const params = new URLSearchParams(window.location.search);
      const userId = params.get("userId");
      const secret = params.get("secret");

      const deepLink = `expoapp://reset-password?userId=${encodeURIComponent(userId || "")}&secret=${encodeURIComponent(secret || "")}`;
      const openAppBtn = document.getElementById("openApp");
      const handoff = document.getElementById("handoff");

      if (userId && secret) {
        handoff.style.display = "block";
        openAppBtn.style.display = "block";
      }

      openAppBtn.addEventListener("click", () => {
        try {
          window.location.href = deepLink;
        } catch {
          Swal.fire({
            icon: 'warning',
            title: 'Uyarı!',
            text: 'Uygulama açılamadı, web üzerinden devam edin.',
            confirmButtonText: 'Tamam',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#ff9800'
          });
        }
      });

      // Web üzerinden reset
      document.getElementById("submit").addEventListener("click", async () => {
        const pass = document.getElementById("password").value.trim();
        const confirm = document.getElementById("confirm").value.trim();

        if (!userId || !secret) {
          Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Bağlantı parametreleri eksik. Maildeki linke tekrar tıklayın.',
            confirmButtonText: 'Tamam',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#f44336'
          });
          return;
        }

        if (pass.length < 8) {
          Swal.fire({
            icon: 'warning',
            title: 'Şifre Kısa!',
            text: 'Şifre en az 8 karakter olmalı.',
            confirmButtonText: 'Tamam',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#ff9800'
          });
          return;
        }

        if (pass !== confirm) {
          Swal.fire({
            icon: 'error',
            title: 'Uyuşmazlık!',
            text: 'Şifreler birbiriyle uyuşmuyor.',
            confirmButtonText: 'Tekrar Dene',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#f44336'
          });
          return;
        }

        try {
          await account.updateRecovery(userId, secret, pass, confirm);
          
          Swal.fire({
            icon: 'success',
            title: 'Başarılı!',
            html: '✅ <strong>Şifre başarıyla güncellendi!</strong><br>Artık giriş yapabilirsiniz 🎉',
            confirmButtonText: 'Harika!',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#4CAF50',
            timer: 5000,
            timerProgressBar: true
          }).then(() => {
            // İsteğe bağlı: Başarılı olunca giriş sayfasına yönlendir
            // window.location.href = '/login';
          });
          
        } catch (err) {
          Swal.fire({
            icon: 'error',
            title: 'İşlem Başarısız!',
            text: 'Hata: ' + (err?.message || 'Bilinmeyen hata oluştu'),
            confirmButtonText: 'Tekrar Dene',
            background: 'rgba(255, 255, 255, 0.95)',
            confirmButtonColor: '#f44336'
          });
        }
      });
    </script>
  </body>
</html>